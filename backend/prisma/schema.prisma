generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model audit_logs {
  id          String      @id
  userId      String?
  collegeId   String?
  publisherId String?
  action      AuditAction
  entityType  String?
  entityId    String?
  description String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime    @default(now())
  colleges    colleges?   @relation(fields: [collegeId], references: [id])
  publishers  publishers? @relation(fields: [publisherId], references: [id])
  users       users?      @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([collegeId])
  @@index([publisherId])
  @@index([timestamp])
  @@index([userId])
}

model colleges {
  id                  String        @id
  name                String
  code                String        @unique
  status              CollegeStatus @default(ACTIVE)
  // Phase 2: Enhanced college metadata
  emailDomain         String?       // Official email domain (e.g., aiims.edu.in)
  adminContactEmail   String?       // IT Admin contact
  address             String?
  city                String?
  state               String?
  // Tracking
  createdAt           DateTime      @default(now())
  updatedAt           DateTime
  // Relations
  audit_logs          audit_logs[]
  courses             courses[]
  departments         departments[]
  students            students[]
  users               users[]
}

// Phase 1: Department structure for HOD-scoped access
model departments {
  id                  String                @id @default(uuid())
  collegeId           String
  name                String
  code                String
  hodId               String?               // User ID of HOD
  status              DepartmentStatus      @default(ACTIVE)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  college             colleges              @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  hod                 users?                @relation("DepartmentHOD", fields: [hodId], references: [id])
  faculty_assignments faculty_assignments[]
  student_departments student_departments[]

  @@unique([collegeId, code])
  @@index([collegeId])
  @@index([hodId])
}

// Phase 1: Faculty assigned to departments with granular permissions
model faculty_assignments {
  id           String              @id @default(uuid())
  userId       String
  departmentId String
  permissions  faculty_permissions @relation(fields: [permissionId], references: [id])
  permissionId String
  subjects     String[]            // Subject codes this faculty can teach
  status       FacultyStatus       @default(ACTIVE)
  assignedAt   DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         users               @relation(fields: [userId], references: [id], onDelete: Cascade)
  department   departments         @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
  @@index([userId])
  @@index([departmentId])
}

// Phase 1: Granular faculty permissions (defined by College Admin)
model faculty_permissions {
  id                  String                @id @default(uuid())
  name                String                // e.g., "Full Access", "Read Only", "Assessment Only"
  collegeId           String
  canCreateCourses    Boolean               @default(false)
  canEditCourses      Boolean               @default(false)
  canDeleteCourses    Boolean               @default(false)
  canCreateMcqs       Boolean               @default(false)
  canEditMcqs         Boolean               @default(false)
  canDeleteMcqs       Boolean               @default(false)
  canViewAnalytics    Boolean               @default(false)
  canAssignStudents   Boolean               @default(false)
  canScheduleLectures Boolean               @default(false)
  canUploadNotes      Boolean               @default(false)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  faculty_assignments faculty_assignments[]

  @@unique([collegeId, name])
  @@index([collegeId])
}

// Phase 1: Students assigned to departments
model student_departments {
  id           String      @id @default(uuid())
  studentId    String
  departmentId String
  assignedAt   DateTime    @default(now())
  student      students    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  department   departments @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([studentId, departmentId])
  @@index([studentId])
  @@index([departmentId])
}

model competencies {
  id                  String                @id
  code                String                @unique
  title               String
  description         String
  subject             String
  domain              CompetencyDomain
  academicLevel       AcademicLevel
  status              CompetencyStatus      @default(ACTIVE)
  version             Int                   @default(1)
  deprecatedAt        DateTime?
  replacedBy          String?
  createdBy           String
  reviewedBy          String?
  activatedAt         DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  course_competencies course_competencies[]

  @@index([academicLevel])
  @@index([code])
  @@index([domain])
  @@index([status])
  @@index([subject])
}

model course_assignments {
  id             String           @id
  courseId       String
  studentId      String
  assignedBy     String
  assignmentType AssignmentType   @default(INDIVIDUAL)
  status         AssignmentStatus @default(ASSIGNED)
  dueDate        DateTime?
  assignedAt     DateTime         @default(now())
  startedAt      DateTime?
  completedAt    DateTime?
  users          users            @relation(fields: [assignedBy], references: [id], onDelete: Cascade)
  courses        courses          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  students       students         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId])
  @@index([assignedBy])
  @@index([courseId])
  @@index([status])
  @@index([studentId])
}

model course_competencies {
  id           String       @id
  courseId     String
  competencyId String
  createdAt    DateTime     @default(now())
  competencies competencies @relation(fields: [competencyId], references: [id], onDelete: Cascade)
  courses      courses      @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, competencyId])
  @@index([competencyId])
  @@index([courseId])
}

model courses {
  id                  String                @id
  facultyId           String
  collegeId           String
  title               String
  description         String?
  academicYear        AcademicYear
  status              CourseStatus          @default(DRAFT)
  metadata            Json?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  courseCode          String?
  course_assignments  course_assignments[]
  course_competencies course_competencies[]
  colleges            colleges              @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  users               users                 @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  learning_flow_steps learning_flow_steps[]
  step_progress       step_progress[]
  student_progress    student_progress[]

  @@index([academicYear])
  @@index([collegeId])
  @@index([facultyId])
  @@index([status])
}

model learning_flow_steps {
  id                 String           @id
  courseId           String
  learningUnitId     String
  stepOrder          Int
  stepType           LearningUnitType
  mandatory          Boolean          @default(true)
  completionCriteria Json?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  isMandatory        Boolean          @default(true)
  prerequisites      String[]         @default([])
  referenceId        String?
  stepNumber         Int
  courses            courses          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  learning_units     learning_units   @relation(fields: [learningUnitId], references: [id], onDelete: Cascade)
  step_progress      step_progress[]

  @@unique([courseId, stepOrder])
  @@index([courseId])
  @@index([learningUnitId])
}

model learning_unit_access_logs {
  id                String         @id
  learningUnitId    String
  userId            String
  collegeId         String?
  accessToken       String
  ipAddress         String?
  userAgent         String?
  deviceType        String?
  sessionStarted    DateTime       @default(now())
  sessionEnded      DateTime?
  duration          Int?
  watermarkPayload  Json?
  violationDetected Boolean        @default(false)
  violationType     String?
  learning_units    learning_units @relation(fields: [learningUnitId], references: [id], onDelete: Cascade)

  @@index([learningUnitId])
  @@index([sessionStarted])
  @@index([userId])
}

model learning_units {
  id                        String                      @id
  publisherId               String
  type                      LearningUnitType
  title                     String
  description               String
  subject                   String
  topic                     String
  subTopic                  String?
  difficultyLevel           DifficultyLevel
  estimatedDuration         Int
  competencyIds             String[]
  secureAccessUrl           String
  deliveryType              DeliveryType
  watermarkEnabled          Boolean                     @default(true)
  sessionExpiryMinutes      Int                         @default(30)
  maxAttempts               Int?
  timeLimit                 Int?
  // Phase 1: Enhanced content lifecycle
  status                    ContentStatus               @default(DRAFT)
  competencyMappingStatus   CompetencyMappingStatus     @default(PENDING)
  activatedAt               DateTime?
  activatedBy               String?
  deactivatedAt             DateTime?
  deactivatedBy             String?
  deactivationReason        String?
  // Content protection (Phase 1)
  downloadAllowed           Boolean                     @default(false)
  viewOnly                  Boolean                     @default(true)
  // Metadata
  thumbnailUrl              String?
  tags                      String[]
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  learning_flow_steps       learning_flow_steps[]
  learning_unit_access_logs learning_unit_access_logs[]
  publishers                publishers                  @relation(fields: [publisherId], references: [id], onDelete: Cascade)

  @@index([difficultyLevel])
  @@index([publisherId])
  @@index([status])
  @@index([competencyMappingStatus])
  @@index([subject])
  @@index([type])
}

model publishers {
  id                  String           @id
  name                String
  code                String           @unique
  status              PublisherStatus  @default(ACTIVE)
  // Phase 2: Contract management
  contactPerson       String?
  contactEmail        String?
  physicalAddress     String?          // Phase 3: Publisher address
  contractStartDate   DateTime?
  contractEndDate     DateTime?
  contractDocument    String?          // URL to contract document
  legalName           String?
  // Tracking
  createdAt           DateTime         @default(now())
  updatedAt           DateTime
  // Relations
  audit_logs          audit_logs[]
  learning_units      learning_units[]
  mcqs                mcqs[]
  users               users[]

  @@index([contractEndDate])
}

model mcqs {
  id                String       @id
  question          String
  questionImage     String?
  optionA           String
  optionB           String
  optionC           String
  optionD           String
  optionE           String?
  correctAnswer     String
  explanation       String?
  explanationImage  String?
  subject           String
  topic             String
  difficultyLevel   DifficultyLevel
  bloomsLevel       BloomsLevel  @default(REMEMBER)
  competencyIds     String[]     @default([])
  tags              String[]     @default([])
  year              Int?
  source            String?
  publisherId       String
  createdBy         String
  status            McqStatus    @default(DRAFT)
  isVerified        Boolean      @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?
  usageCount        Int          @default(0)
  correctRate       Float        @default(0)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime
  publisher         publishers   @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  creator           users        @relation("McqCreator", fields: [createdBy], references: [id])
  verifier          users?       @relation("McqVerifier", fields: [verifiedBy], references: [id])

  @@index([publisherId])
  @@index([subject])
  @@index([status])
  @@index([createdBy])
  @@index([competencyIds], type: Gin)
}

model refresh_tokens {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model security_policies {
  id                     String   @id
  sessionTimeoutMinutes  Int      @default(60)
  tokenExpiryMinutes     Int      @default(15)
  refreshTokenExpiryDays Int      @default(30)
  maxConcurrentSessions  Int      @default(3)
  watermarkEnabled       Boolean  @default(true)
  screenshotPrevention   Boolean  @default(true)
  publisherPortalEnabled Boolean  @default(true)
  facultyPortalEnabled   Boolean  @default(true)
  studentPortalEnabled   Boolean  @default(true)
  mobileAppEnabled       Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime
}

model step_progress {
  id                  String              @id
  studentId           String
  stepId              String
  courseId            String
  position            Int                 @default(0)
  duration            Int?
  completionPercent   Int                 @default(0)
  timeSpentSeconds    Int                 @default(0)
  attempts            Int                 @default(0)
  lastAccessedAt      DateTime            @default(now())
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  courses             courses             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  learning_flow_steps learning_flow_steps @relation(fields: [stepId], references: [id], onDelete: Cascade)
  students            students            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, stepId])
  @@index([courseId])
  @@index([stepId])
  @@index([studentId])
}

model student_progress {
  id             String         @id
  studentId      String
  courseId       String
  status         ProgressStatus @default(NOT_STARTED)
  completedAt    DateTime?
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  completedSteps String[]       @default([])
  currentStepId  String?
  startedAt      DateTime?
  courses        courses        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  students       students       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([courseId])
  @@index([status])
  @@index([studentId])
}

model students {
  id                   String                @id
  collegeId            String
  userId               String                @unique
  fullName             String
  yearOfAdmission      Int
  expectedPassingYear  Int
  currentAcademicYear  AcademicYear
  status               StudentStatus         @default(ACTIVE)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime
  course_assignments   course_assignments[]
  step_progress        step_progress[]
  student_progress     student_progress[]
  student_departments  student_departments[]
  colleges             colleges              @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  users                users                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([collegeId])
  @@index([currentAcademicYear])
  @@index([status])
  @@index([userId])
}

model user_sessions {
  id                String   @id
  userId            String
  deviceFingerprint String?
  platform          String?
  ipAddress         String?
  userAgent         String?
  isActive          Boolean  @default(true)
  expiresAt         DateTime
  createdAt         DateTime @default(now())
  lastActivityAt    DateTime @default(now())
  users             users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([userId])
}

model users {
  id                  String                @id
  email               String                @unique
  passwordHash        String
  fullName            String
  role                UserRole
  status              UserStatus            @default(ACTIVE)
  collegeId           String?
  publisherId         String?
  // Phase 1: Enhanced user fields
  departmentId        String?               // For HOD/Faculty department scope
  lastLoginAt         DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  audit_logs          audit_logs[]
  course_assignments  course_assignments[]
  courses             courses[]
  refresh_tokens      refresh_tokens[]
  students            students?
  user_sessions       user_sessions[]
  mcqsCreated         mcqs[]                @relation("McqCreator")
  mcqsVerified        mcqs[]                @relation("McqVerifier")
  colleges            colleges?             @relation(fields: [collegeId], references: [id])
  publishers          publishers?           @relation(fields: [publisherId], references: [id])
  // Phase 1: New relations
  departmentsAsHOD    departments[]         @relation("DepartmentHOD")
  faculty_assignments faculty_assignments[]

  @@index([collegeId])
  @@index([departmentId])
  @@index([email])
  @@index([publisherId])
  @@index([role])
}

enum AcademicLevel {
  UG
  PG
  SPECIALIZATION
}

enum AcademicYear {
  FIRST_YEAR
  SECOND_YEAR
  THIRD_YEAR
  FOURTH_YEAR
  FIFTH_YEAR
  INTERNSHIP
}

enum AssignmentStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

enum AssignmentType {
  INDIVIDUAL
  BATCH
}

enum AuditAction {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  SESSION_EXPIRED
  TOKEN_REFRESHED
  PASSWORD_CHANGED
  USER_CREATED
  USER_UPDATED
  USER_SUSPENDED
  USER_ACTIVATED
  COLLEGE_CREATED
  COLLEGE_UPDATED
  COLLEGE_SUSPENDED
  COLLEGE_ACTIVATED
  PUBLISHER_CREATED
  PUBLISHER_UPDATED
  PUBLISHER_SUSPENDED
  PUBLISHER_ACTIVATED
  UNAUTHORIZED_ACCESS
  INVALID_TOKEN
  SECURITY_VIOLATION
  CONCURRENT_SESSION_LIMIT
  CONTENT_ACCESSED
  CONTENT_COMPLETED
  SECURITY_POLICY_UPDATED
  COMPETENCY_CREATED
  COMPETENCY_REVIEWED
  COMPETENCY_ACTIVATED
  COMPETENCY_DEPRECATED
  LEARNING_UNIT_CREATED
  LEARNING_UNIT_UPDATED
  LEARNING_UNIT_ACTIVATED
  LEARNING_UNIT_SUSPENDED
  LEARNING_UNIT_ACCESSED
  ACCESS_TOKEN_GENERATED
  SECURITY_VIOLATION_DETECTED
  STUDENT_CREATED
  STUDENT_UPDATED
  STUDENT_ACTIVATED
  STUDENT_DEACTIVATED
  STUDENT_PROMOTED
  STUDENT_BULK_PROMOTED
  STUDENT_CREDENTIALS_RESET
  COURSE_CREATED
  COURSE_UPDATED
  COURSE_PUBLISHED
  COURSE_ASSIGNED
  FLOW_STEP_COMPLETED
  BLOCKED_ACCESS_ATTEMPT
  BLOCKED_ACCESS
  STEP_SKIP_ATTEMPT
  FORCED_API_CALL
  FLOW_MODIFIED
  STEP_COMPLETED
  INVALID_COMPLETION
  // Phase 1: Department Management
  DEPARTMENT_CREATED
  DEPARTMENT_UPDATED
  DEPARTMENT_DEACTIVATED
  HOD_ASSIGNED
  HOD_REMOVED
  // Phase 1: Faculty Permissions
  FACULTY_PERMISSION_CREATED
  FACULTY_PERMISSION_UPDATED
  FACULTY_ASSIGNED_TO_DEPARTMENT
  FACULTY_REMOVED_FROM_DEPARTMENT
  FACULTY_PERMISSIONS_CHANGED
  // Phase 1: Content Lifecycle
  CONTENT_SUBMITTED_FOR_MAPPING
  CONTENT_COMPETENCY_MAPPED
  CONTENT_ACTIVATED
  CONTENT_DEACTIVATED
  CONTENT_SUSPENDED
  CONTENT_MAPPING_INCOMPLETE
  // Phase 1: Governance
  ROLE_BOUNDARY_VIOLATION
  CROSS_TENANT_ACCESS_ATTEMPT
  PERMISSION_DENIED
  DATA_ISOLATION_BREACH_ATTEMPT
}

enum CollegeStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum CompetencyDomain {
  COGNITIVE
  CLINICAL
  PRACTICAL
}

enum CompetencyStatus {
  DRAFT
  ACTIVE
  DEPRECATED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum DeliveryType {
  REDIRECT
  EMBED
  STREAM
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

// Phase 1: New content lifecycle status (replaces LearningUnitStatus)
enum ContentStatus {
  DRAFT              // Initial creation state
  PENDING_MAPPING    // Content uploaded but competency mapping incomplete
  ACTIVE             // Competency mapped, content available
  INACTIVE           // Deactivated by publisher
  SUSPENDED          // Suspended by Bitflow Owner
}

// Phase 1: Competency mapping status for content
enum CompetencyMappingStatus {
  PENDING            // No competencies mapped yet
  PARTIAL            // Some competencies mapped
  COMPLETE           // All required competencies mapped
}

// Phase 1: Department status
enum DepartmentStatus {
  ACTIVE
  INACTIVE
}

// Phase 1: Faculty assignment status
enum FacultyStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

enum LearningUnitStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum LearningUnitType {
  BOOK
  VIDEO
  MCQ
  NOTES
}

enum McqStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum BloomsLevel {
  REMEMBER
  UNDERSTAND
  APPLY
  ANALYZE
  EVALUATE
  CREATE
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum PublisherStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  DROPPED_OUT
}

enum UserRole {
  BITFLOW_OWNER
  PUBLISHER_ADMIN
  COLLEGE_ADMIN
  COLLEGE_DEAN
  COLLEGE_HOD
  FACULTY
  STUDENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}
